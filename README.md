# å–ä¹¦ç½‘ç«™ä»·å·®æ•°æ®åˆ†æç³»ç»Ÿ v3.0

## ç³»ç»Ÿç®€ä»‹

ä¸“é—¨åˆ†æå­”å¤«å­æ—§ä¹¦ç½‘å’Œå¤šæŠ“é±¼ä¸¤ä¸ªå¹³å°ä¹¦ç±ä»·å·®çš„æ•°æ®ç³»ç»Ÿï¼Œé€šè¿‡æ™ºèƒ½çˆ¬è™«å‘ç°å¥—åˆ©æœºä¼šã€‚é‡‡ç”¨å…¨æ–°çš„**è‡ªä¸»ä¼šè¯ç®¡ç†å™¨æ¶æ„**ï¼Œå®ç°ä¸šåŠ¡å±‚ä¸çˆ¬è™«å·¥å…·çš„å®Œå…¨è§£è€¦ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
# ä½¿ç”¨uvï¼ˆæ¨èï¼‰
uv sync

# æˆ–ä½¿ç”¨pip
pip install -r requirements.txt
playwright install chromium
```

### 2. å¯åŠ¨Chromeï¼ˆçˆ¬è™«éœ€è¦ï¼‰
```bash
# macOS
/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --remote-debugging-port=9222

# Windows  
"C:\Program Files\Google\Chrome\Application\chrome.exe" --remote-debugging-port=9222

# Linux
google-chrome --remote-debugging-port=9222
```

### 3. å¯åŠ¨ç³»ç»Ÿ
```bash
uv run python run.py
```

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### ğŸ“Š æ•°æ®åˆ†æåŠŸèƒ½
- **ISBNå®æ—¶æœç´¢**ï¼šè¾“å…¥ISBNå³å¯è·å–é”€é‡æ’è¡Œã€ä»·æ ¼åˆ†å¸ƒã€é”€å”®è¶‹åŠ¿
- **æ™ºèƒ½å»é‡æœºåˆ¶**ï¼šé‡‡ç”¨å­”å¤«å­ç½‘item_idä½œä¸ºä¸»é”®ï¼Œç¡®ä¿é”€å”®è®°å½•å”¯ä¸€æ€§
- **å“ç›¸æ™ºèƒ½ç­›é€‰**ï¼šæ”¯æŒ"ä¹å“ä»¥ä¸Š"å’Œ"å…¨éƒ¨å“ç›¸"ä¸¤ç§æ•°æ®æº
- **åŠ¨æ€ä»·æ ¼åˆ†åŒº**ï¼šè‡ªåŠ¨è®¡ç®—5ä¸ªä»·æ ¼åŒºé—´ï¼Œé€‚ç”¨äºä»»æ„ä»·ä½ä¹¦ç±
- **æˆæœ¬ä»·æ ¼å¯¹æ¯”**ï¼šé›†æˆå¤šæŠ“é±¼æ”¶è´­ä»·ä½œä¸ºæˆæœ¬å‚è€ƒ

### ğŸ¤– æ™ºèƒ½çˆ¬è™«ç³»ç»Ÿ
é‡‡ç”¨**è‡ªä¸»ä¼šè¯ç®¡ç†å™¨**æ¶æ„ï¼Œä¸šåŠ¡å±‚å®Œå…¨æ— éœ€å…³å¿ƒçˆ¬è™«å·¥å…·ï¼š

- **å®Œå…¨è‡ªä¸»è¿è¡Œ**ï¼šåå°è‡ªåŠ¨è½®è¯¢ä»»åŠ¡é˜Ÿåˆ—å¹¶æ‰§è¡Œ
- **æ™ºèƒ½ç½‘ç«™ç®¡ç†**ï¼šæ¯ä¸ªçª—å£å†…å¤šä¸ªç½‘ç«™çŠ¶æ€ç‹¬ç«‹ï¼ŒæŸä¸ªç½‘ç«™è¢«å°ä¸å½±å“å…¶ä»–ç½‘ç«™
- **è‡ªåŠ¨çŠ¶æ€æ¢å¤**ï¼šé¢‘ç‡é™åˆ¶è‡ªåŠ¨åœ¨6åˆ†é’Ÿåè§£å°
- **é›¶é…ç½®ä½¿ç”¨**ï¼šä¸šåŠ¡å±‚åªéœ€æ·»åŠ ä»»åŠ¡ï¼Œæ— éœ€å…³å¿ƒçª—å£æ± å’Œæµè§ˆå™¨ç®¡ç†

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### V3.0 æ ¸å¿ƒæ¶æ„ç†å¿µ

æœ¬ç³»ç»Ÿé‡‡ç”¨**åˆ†å±‚è§£è€¦**çš„è®¾è®¡ç†å¿µï¼Œç¡®ä¿ä¸šåŠ¡å±‚ä¸çˆ¬è™«æ‰§è¡Œå±‚å®Œå…¨åˆ†ç¦»ï¼š

#### ğŸ“‹ å››å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1. ä»»åŠ¡åˆ›å»º
â”‚  ä¸šåŠ¡å±‚     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æ•°æ®åº“ (status='pending')
â”‚ (Business)  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                           â”‚ 2. æ‰‹åŠ¨è°ƒåº¦
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  è°ƒåº¦å±‚     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ (Scheduler) â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º å†…å­˜é˜Ÿåˆ— (loaded tasks)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                           â”‚ 3. è‡ªåŠ¨æ‰§è¡Œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  æ‰§è¡Œå±‚     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚(Execution)  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º çª—å£ç®¡ç† + ä»»åŠ¡å¤„ç†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                           â”‚ 4. å®é™…çˆ¬å–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  çˆ¬è™«å±‚     â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ (Crawler)   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ç½‘ç«™æ•°æ®è·å–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ¯ åˆ†å±‚èŒè´£

| å±‚çº§ | ç»„ä»¶ | èŒè´£ | å…³é”®åŸåˆ™ |
|------|------|------|----------|
| **ä¸šåŠ¡å±‚** | API Routes | åªè´Ÿè´£åˆ›å»ºä»»åŠ¡åˆ°æ•°æ®åº“ | ä¸æ¶‰åŠå…·ä½“çˆ¬å–æ‰§è¡Œ |
| **è°ƒåº¦å±‚** | Task Scheduler | å°† pending ä»»åŠ¡åŠ è½½åˆ°å†…å­˜é˜Ÿåˆ— | æ‰‹åŠ¨è§¦å‘ï¼ˆçˆ¬è™«ç®¡ç†é¡µé¢æŒ‰é’®ï¼‰ |
| **æ‰§è¡Œå±‚** | AutonomousSessionManager | ä»å†…å­˜é˜Ÿåˆ—è·å–ä»»åŠ¡å¹¶åˆ†é…çª—å£ | ç»Ÿä¸€çª—å£åˆ†å‘ä¸­å¿ƒ |
| **çˆ¬è™«å±‚** | Crawler Methods | æ¥å—åˆ†é…çš„çª—å£æ‰§è¡Œå…·ä½“çˆ¬å– | ä½¿ç”¨ @WindowPoolManager() è£…é¥°å™¨ |

#### ğŸ”„ å®Œæ•´ä»»åŠ¡æµç¨‹

```mermaid
graph TD
    A[ä¸šåŠ¡æ“ä½œ] --> B[æ•°æ®åº“ä»»åŠ¡è¡¨ status='pending']
    B --> C[è°ƒåº¦å™¨ï¼šæ‰‹åŠ¨è§¦å‘]
    C --> D[åŠ è½½åˆ°å†…å­˜é˜Ÿåˆ—]
    D --> E[AutonomousSessionManager]
    E --> F[çª—å£åˆ†é…]
    F --> G[çˆ¬è™«æ–¹æ³•æ‰§è¡Œ]
    G --> H[æ›´æ–°ä»»åŠ¡çŠ¶æ€]
    
    style A fill:#e1f5fe
    style E fill:#f3e5f5
    style G fill:#e8f5e8
```

#### ğŸ¨ æ ¸å¿ƒè®¾è®¡åŸåˆ™

##### 1. **WindowPoolManager è£…é¥°å™¨ç»Ÿä¸€çª—å£ç®¡ç†**
```python
# âœ… æ­£ç¡®çš„çˆ¬è™«æ–¹æ³•è®¾è®¡
class KongfuziCrawler:
    @WindowPoolManager()
    async def analyze_book_sales(self, isbn: str, days_limit: int = 30, page: Page = None):
        """åˆ†æå•æœ¬ä¹¦çš„é”€å”®è®°å½•
        
        Args:
            isbn: ä¹¦ç±ISBNå·
            days_limit: å¤©æ•°é™åˆ¶
            page: æµè§ˆå™¨é¡µé¢ï¼ˆç”±è£…é¥°å™¨è‡ªåŠ¨æ³¨å…¥ï¼‰
        """
        # è£…é¥°å™¨å·²ç»è‡ªåŠ¨è·å–çª—å£å¹¶æ³¨å…¥pageå‚æ•°
        # çˆ¬è™«æ–¹æ³•åªéœ€ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
        await page.goto(f"https://www.kongfz.com/book/{isbn}")
        # ... å…·ä½“çˆ¬å–é€»è¾‘
        return results

# WindowPoolManager è£…é¥°å™¨å·¥ä½œæµç¨‹ï¼š
# 1. è°ƒç”¨ autonomous_session_manager.get_window() è·å–å¯ç”¨çª—å£
# 2. å°† page å‚æ•°è‡ªåŠ¨æ³¨å…¥åˆ°çˆ¬è™«æ–¹æ³•çš„ kwargs ä¸­
# 3. æ‰§è¡Œçˆ¬è™«æ–¹æ³•ï¼Œç›‘æ§å¼‚å¸¸æƒ…å†µ
# 4. æ ¹æ®å¼‚å¸¸ç±»å‹è‡ªåŠ¨æ ‡è®°çª—å£çŠ¶æ€ï¼š
#    - LOGIN_REQUIRED: æ ‡è®°ä¸ºéœ€è¦ç™»å½•
#    - RATE_LIMITED: æ ‡è®°ä¸ºé¢‘ç‡é™åˆ¶ï¼ˆ6åˆ†é’Ÿåè‡ªåŠ¨æ¢å¤ï¼‰
#    - æˆåŠŸï¼šæ ‡è®°çª—å£ä¸ºæ­£å¸¸çŠ¶æ€
# 5. è‡ªåŠ¨å½’è¿˜çª—å£åˆ° autonomous_session_manager
```

##### WindowPoolManager è£…é¥°å™¨è¯¦è§£

```python
class WindowPoolManager:
    def __init__(self, pool=None, keep_window_alive: bool = True):
        # pool é»˜è®¤æŒ‡å‘ autonomous_session_manager
        self.pool = pool or autonomous_session_manager
        self.keep_window_alive = keep_window_alive
    
    def __call__(self, func):
        async def wrapper(*args, **kwargs):
            # è‡ªåŠ¨è·å–çª—å£
            page = await self.pool.get_window()
            if not page:
                raise Exception("æ— æ³•è·å–å¯ç”¨çš„æµè§ˆå™¨çª—å£")
            
            try:
                # æ³¨å…¥ page å‚æ•°
                kwargs['page'] = page
                result = await func(*args, **kwargs)
                
                # æ ‡è®°æˆåŠŸ
                self.pool.mark_window_success(page)
                return result
            except Exception as e:
                # æ™ºèƒ½é”™è¯¯å¤„ç†
                if "LOGIN_REQUIRED:" in str(e):
                    self.pool.mark_window_login_required(page)
                elif "RATE_LIMITED:" in str(e):
                    self.pool.mark_window_rate_limited(page, duration_minutes=6)
                raise
            finally:
                # è‡ªåŠ¨å½’è¿˜çª—å£
                await self.pool.return_window(page, keep_alive=self.keep_window_alive)
        return wrapper
```

##### 2. **è£…é¥°å™¨è‡ªåŠ¨å¤„ç†çª—å£ç”Ÿå‘½å‘¨æœŸ**
- WindowPoolManager è£…é¥°å™¨å†…éƒ¨ä½¿ç”¨ `autonomous_session_manager` è·å–çª—å£
- è‡ªåŠ¨å¤„ç†çª—å£çš„è·å–ã€å¼‚å¸¸å¤„ç†ã€çŠ¶æ€æ ‡è®°ã€å½’è¿˜
- çˆ¬è™«æ–¹æ³•å®Œå…¨æ— éœ€å…³å¿ƒçª—å£ç®¡ç†ï¼Œåªéœ€ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
- æ™ºèƒ½é”™è¯¯å¤„ç†ï¼šè‡ªåŠ¨è¯†åˆ«ç™»å½•é”™è¯¯ã€é¢‘ç‡é™åˆ¶ç­‰çŠ¶æ€

##### 3. **ä¸šåŠ¡å±‚é›¶è€¦åˆ**
```python
# âœ… ä¸šåŠ¡å±‚åªå…³å¿ƒä»»åŠ¡åˆ›å»º
def create_crawl_task(isbn: str, shop_id: int):
    task = CrawlTask(
        task_type='book_sales_crawl',
        target_isbn=isbn,
        shop_id=shop_id,
        status='pending'  # åªåˆ›å»ºï¼Œä¸æ‰§è¡Œ
    )
    return task_repo.create(task)
```

##### 4. **è°ƒåº¦å±‚æ‰‹åŠ¨æ§åˆ¶**

**ğŸ¯ åˆå§‹åŒ–è¦æ±‚**ï¼š
- **çª—å£æ± å¿…é¡»æ‰‹åŠ¨åˆå§‹åŒ–**ï¼šåªèƒ½é€šè¿‡ `/window-pool-admin` é¡µé¢çš„"åˆå§‹åŒ–çª—å£æ± "æŒ‰é’®
- **ä¸ä¼šè‡ªåŠ¨å¯åŠ¨**ï¼šç³»ç»Ÿå¯åŠ¨æ—¶ä¸ä¼šè‡ªåŠ¨åˆ›å»ºçª—å£ï¼Œé¿å…èµ„æºæµªè´¹
- **é»˜è®¤çª—å£æ•°é‡**ï¼š2ä¸ªçª—å£ï¼ˆä¸åŸwindow_poolä¿æŒä¸€è‡´ï¼‰

**ğŸ“‹ ä»»åŠ¡æ§åˆ¶**ï¼š
ä»»åŠ¡æ‰§è¡Œå®Œå…¨å¯æ§ï¼Œé€šè¿‡å„ç®¡ç†é¡µé¢çš„æŒ‰é’®æ‰‹åŠ¨è§¦å‘ï¼š
- ğŸš€ **ä¸€é”®å¯åŠ¨æ‰€æœ‰ä»»åŠ¡**ï¼šå°† pending ä»»åŠ¡åŠ è½½åˆ°å†…å­˜é˜Ÿåˆ—
- ğŸ—‘ï¸ **ä¸€é”®æ¸…ç©ºä»»åŠ¡é˜Ÿåˆ—**ï¼šæ¸…ç©ºå†…å­˜é˜Ÿåˆ—ï¼ˆä¸å½±å“æ•°æ®åº“ï¼‰
- ğŸ”„ **æ‰€æœ‰å¤±è´¥ä»»åŠ¡é‡è¯•**ï¼šé‡æ–°åŠ è½½å¤±è´¥ä»»åŠ¡åˆ°å†…å­˜é˜Ÿåˆ—
- â–¶ï¸ **æ‰§è¡Œé€‰ä¸­ä»»åŠ¡**ï¼šæŒ‡å®šä»»åŠ¡åŠ è½½åˆ°é˜Ÿåˆ—

### V3.0 æ¶æ„å›¾
```
ä¸šåŠ¡å±‚ â”€â”€â”€â”€â–º æ•°æ®åº“ä»»åŠ¡è¡¨ (pending)
               â”‚
               â”‚ æ‰‹åŠ¨è°ƒåº¦è§¦å‘
               â–¼
           å†…å­˜ä»»åŠ¡é˜Ÿåˆ—
               â”‚
               â”‚ è‡ªåŠ¨è½®è¯¢
               â–¼
    AutonomousSessionManager
    â”‚
    â”œâ”€ çª—å£æ± ç®¡ç† (Chrome 9222)
    â”œâ”€ å°æ§çŠ¶æ€è¿½è¸ª
    â”œâ”€ æ™ºèƒ½ä»»åŠ¡åˆ†å‘
    â””â”€ ç»Ÿä¸€é”™è¯¯å¤„ç†
               â”‚
               â–¼
         çˆ¬è™«æ–¹æ³•æ‰§è¡Œ
    (@WindowPoolManager è£…é¥°å™¨è‡ªåŠ¨ç®¡ç†çª—å£)
```

**æ ¸å¿ƒç»„ä»¶**ï¼š

1. **CrawlerServiceV2**ï¼šç»Ÿä¸€ä¸šåŠ¡å…¥å£ï¼Œæä¾›ç®€å•çš„ä»»åŠ¡ç®¡ç†API
2. **TaskScheduler**ï¼šè°ƒåº¦å±‚ï¼Œè´Ÿè´£æ•°æ®åº“ä»»åŠ¡åˆ°å†…å­˜é˜Ÿåˆ—çš„åŠ è½½
3. **AutonomousSessionManager**ï¼šæ‰§è¡Œå±‚ï¼Œç»Ÿä¸€çª—å£åˆ†å‘ä¸­å¿ƒ
4. **Crawler Methods**ï¼šçˆ¬è™«å±‚ï¼Œä½¿ç”¨ @WindowPoolManager() è£…é¥°å™¨è‡ªåŠ¨è·å–çª—å£

## ğŸ“± è®¿é—®åœ°å€

- **ä¸»é¡µ**: http://127.0.0.1:8282/ - æ•°æ®å±•ç¤ºå’ŒISBNæœç´¢
- **APIæ–‡æ¡£**: http://127.0.0.1:8282/docs

## ğŸ’» ä¸šåŠ¡ä½¿ç”¨ç¤ºä¾‹

### æ·»åŠ çˆ¬è™«ä»»åŠ¡ï¼ˆè¶…ç®€å•ï¼‰
```python
from src.services.crawler_service_v2 import crawler_service_v2

# ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€ä»»ä½•åˆå§‹åŒ–ï¼
# 1. çˆ¬å–å•æœ¬ä¹¦é”€å”®è®°å½•
task_id = crawler_service_v2.add_book_sales_task("9787544291200")

# 2. å¿«é€Ÿçˆ¬å–ISBNç›¸å…³æ•°æ®
task_ids = crawler_service_v2.quick_crawl_isbn("9787544291200")

# 3. æ‰¹é‡æ·»åŠ å¤šä¸ªISBN
isbn_list = ["9787020002207", "9787108006240"]
batch_ids = crawler_service_v2.batch_add_isbn_tasks(isbn_list)

# 4. æ·»åŠ åº—é“ºçˆ¬å–ä»»åŠ¡
shop_task = crawler_service_v2.add_shop_books_task(
    shop_url="https://shop123.kongfz.com/",
    max_pages=10
)
```

### ç›‘æ§ä»»åŠ¡çŠ¶æ€
```python
# è·å–å®Œæ•´çŠ¶æ€
status = await crawler_service_v2.get_queue_status()

# æŸ¥çœ‹ç‰¹å®šå¹³å°çŠ¶æ€
kongfuzi_status = await crawler_service_v2.get_platform_status('kongfuzi')

# å¥åº·æ£€æŸ¥
health = await crawler_service_v2.health_check()

# ç»Ÿè®¡ä¿¡æ¯
stats = await crawler_service_v2.get_statistics()
```

### é˜Ÿåˆ—ç®¡ç†æ“ä½œ
```python
# é‡è¯•å¤±è´¥ä»»åŠ¡
retried = crawler_service_v2.retry_failed_tasks('kongfuzi')

# æ¸…ç©ºå¾…å¤„ç†ä»»åŠ¡
cleared = crawler_service_v2.clear_pending_tasks('kongfuzi')

# ç´§æ€¥åœæ­¢å¹³å°
result = crawler_service_v2.emergency_stop_platform('kongfuzi')
```

## ğŸ”§ é¡¹ç›®ç»“æ„

```
sellbook/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ models/                      # æ•°æ®æ¨¡å‹å±‚
â”‚   â”‚   â”œâ”€â”€ database.py             # æ•°æ®åº“è¿æ¥ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ models.py               # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”‚   â””â”€â”€ repositories.py        # æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ services/                   # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ crawler_service_v2.py   # çˆ¬è™«æœåŠ¡V2ï¼ˆç»Ÿä¸€å…¥å£ï¼‰
â”‚   â”‚   â”œâ”€â”€ autonomous_session_manager.py  # è‡ªä¸»ä¼šè¯ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ simple_task_queue.py    # ç®€åŒ–ä»»åŠ¡é˜Ÿåˆ—
â”‚   â”‚   â”œâ”€â”€ analysis_service.py     # æ•°æ®åˆ†ææœåŠ¡
â”‚   â”‚   â””â”€â”€ isbn_crawler.py         # ISBNçˆ¬è™«
â”‚   â”œâ”€â”€ routes/                     # APIè·¯ç”±å±‚
â”‚   â”‚   â””â”€â”€ api_routes.py          # ç»Ÿä¸€APIæ¥å£
â”‚   â”œâ”€â”€ static/                     # å‰ç«¯æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ index.html             # ä¸»ç•Œé¢
â”‚   â””â”€â”€ main.py                     # FastAPIåº”ç”¨å…¥å£
â”œâ”€â”€ tests/                          # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ test_crawler_service_v2.py # V2æ¶æ„æµ‹è¯•
â”‚   â””â”€â”€ ...
â”œâ”€â”€ data/
â”‚   â””â”€â”€ sellbook.db                # SQLiteæ•°æ®åº“
â”œâ”€â”€ CLAUDE.md                      # å¼€å‘æŒ‡å—
â””â”€â”€ README.md                      # é¡¹ç›®æ–‡æ¡£
```

## ğŸ§  æ™ºèƒ½ç‰¹æ€§

### ç½‘ç«™çŠ¶æ€ç®¡ç†
- **AVAILABLE**: å¯ç”¨çŠ¶æ€ï¼Œæ­£å¸¸è®¿é—®
- **RATE_LIMITED**: é¢‘ç‡é™åˆ¶ï¼Œè‡ªåŠ¨åœ¨6åˆ†é’Ÿåè§£å°
- **LOGIN_REQUIRED**: éœ€è¦ç™»å½•ï¼Œéœ€è¦äººå·¥å¤„ç†
- **ERROR**: ä¸€èˆ¬é”™è¯¯çŠ¶æ€

### ä»»åŠ¡æ™ºèƒ½åˆ†å‘
- **ä¼˜å…ˆçº§æ’åº**ï¼šæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜
- **å¯ç”¨æ€§æ£€æŸ¥**ï¼šåªé€‰æ‹©å¯ç”¨çª—å£çš„ä»»åŠ¡
- **è´Ÿè½½å‡è¡¡**ï¼šè‡ªåŠ¨åˆ†é…åˆ°ä¸åŒçª—å£
- **å¹³å°éš”ç¦»**ï¼šä¸åŒå¹³å°ä»»åŠ¡ç‹¬ç«‹æ‰§è¡Œ

### è‡ªåŠ¨é”™è¯¯å¤„ç†
- **é¢‘ç‡é™åˆ¶**ï¼šè‡ªåŠ¨æ ‡è®°å¹¶ç­‰å¾…è§£å°
- **ç™»å½•é”™è¯¯**ï¼šæ ‡è®°çª—å£éœ€è¦ç™»å½•ï¼Œè·³è¿‡ä½¿ç”¨
- **ç½‘ç»œé”™è¯¯**ï¼šæ ‡è®°ä¸€èˆ¬é”™è¯¯ï¼Œå¯é‡è¯•
- **è¶…æ—¶å¤„ç†**ï¼š5åˆ†é’Ÿè¶…æ—¶è‡ªåŠ¨æ ‡è®°å¤±è´¥

## ğŸ“Š æ•°æ®åº“ç»“æ„

### ä¸»è¦æ•°æ®è¡¨
- **shops** - åº—é“ºä¿¡æ¯è¡¨
- **books** - ä¹¦ç±åŸºç¡€ä¿¡æ¯è¡¨
- **book_inventory** - ä¹¦ç±åº“å­˜ä»·æ ¼è¡¨
- **sales_records** - é”€å”®è®°å½•è¡¨ï¼ˆä½¿ç”¨item_idä½œä¸ºä¸»é”®å»é‡ï¼‰
- **crawl_tasks** - çˆ¬è™«ä»»åŠ¡è¡¨ï¼ˆå«target_platformå­—æ®µï¼‰

### å»é‡æœºåˆ¶
ç³»ç»Ÿé‡‡ç”¨å­”å¤«å­ç½‘çš„`item_id`ä½œä¸ºä¸»é”®ï¼Œç¡®ä¿é”€å”®è®°å½•çš„å”¯ä¸€æ€§ï¼š
```sql
CREATE TABLE sales_records (
    item_id TEXT PRIMARY KEY,  -- å­”å¤«å­ç½‘å•†å“IDï¼ˆå”¯ä¸€ï¼‰
    isbn TEXT,
    title TEXT,
    sale_price REAL,
    sale_time TIMESTAMP,
    quality TEXT,
    shop_id TEXT
);
```

## ğŸ”— APIæ¥å£

### æ•°æ®åˆ†æAPI
- `GET /api/isbn/{isbn}/analysis` - ISBNåˆ†æï¼ˆæ”¯æŒå“ç›¸ç­›é€‰ï¼‰
- `GET /api/dashboard` - è·å–ä»ªè¡¨æ¿æ•°æ®
- `GET /api/sales/statistics` - è·å–é”€å”®ç»Ÿè®¡

### ä»»åŠ¡ç®¡ç†APIï¼ˆV3.0æ–°å¢ï¼‰
çˆ¬è™«ä»»åŠ¡é€šè¿‡ä»£ç APIç®¡ç†ï¼Œæ— éœ€HTTPæ¥å£ï¼š
```python
# é€šè¿‡CrawlerServiceV2ç®¡ç†æ‰€æœ‰ä»»åŠ¡
crawler_service_v2.add_book_sales_task()
crawler_service_v2.get_queue_status()
crawler_service_v2.retry_failed_tasks()
```

## ğŸ§ª æµ‹è¯•

### è¿è¡Œæµ‹è¯•
```bash
# æµ‹è¯•æ–°æ¶æ„
python test_crawler_service_v2.py

# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
pytest

# æµ‹è¯•è¦†ç›–ç‡
pytest --cov=src --cov-report=html
```

### æµ‹è¯•è¦†ç›–
- æœåŠ¡åˆå§‹åŒ–å’Œå¥åº·æ£€æŸ¥
- ä»»åŠ¡ç®¡ç†å’Œæ‰¹é‡æ“ä½œ
- çŠ¶æ€æŸ¥è¯¢å’Œç›‘æ§
- é˜Ÿåˆ—ç®¡ç†å’Œé”™è¯¯å¤„ç†
- å®æ—¶ä»»åŠ¡å¤„ç†ç›‘æ§

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**ï¼šFastAPI 0.100+
- **æ•°æ®åº“**ï¼šSQLite 3
- **çˆ¬è™«æŠ€æœ¯**ï¼šPatchright + BeautifulSoup
- **å¼‚æ­¥å¤„ç†**ï¼šasyncio/aiohttp
- **å‰ç«¯æŠ€æœ¯**ï¼šåŸç”ŸHTML/CSS/JavaScript + Chart.js
- **Pythonç‰ˆæœ¬**ï¼š3.8+
- **æµ‹è¯•æ¡†æ¶**ï¼špytest

## ğŸš¨ é‡è¦è¯´æ˜

### V3.0æ¶æ„ä¼˜åŠ¿
ç›¸æ¯”æ—§ç‰ˆæœ¬çš„æ‰‹åŠ¨ä»»åŠ¡ç®¡ç†ï¼Œæ–°æ¶æ„å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

| ç‰¹æ€§ | V2.xæ¶æ„ | V3.0æ¶æ„ |
|------|----------|----------|
| çª—å£ç®¡ç† | ä¸šåŠ¡å±‚éœ€è¦å…³å¿ƒ | å®Œå…¨é€æ˜ |
| ä»»åŠ¡è°ƒåº¦ | æ‰‹åŠ¨è§¦å‘ | è‡ªä¸»è½®è¯¢ |
| çŠ¶æ€ç®¡ç† | å…¨å±€å…±äº« | ç½‘ç«™ç‹¬ç«‹ |
| é”™è¯¯å¤„ç† | å¤æ‚é‡è¯•é€»è¾‘ | æ™ºèƒ½çŠ¶æ€åˆ†ç±» |
| ä¸šåŠ¡å¤æ‚åº¦ | é«˜ | ä½ |
| æ‰©å±•æ€§ | å›°éš¾ | å®¹æ˜“ |

### è¿ç§»æŒ‡å—
å¦‚æœæ‚¨åœ¨ä½¿ç”¨æ—§ç‰ˆæœ¬ï¼Œå»ºè®®è¿ç§»åˆ°V3.0æ¶æ„ï¼š

1. åŸæœ‰çš„HTTPä»»åŠ¡ç®¡ç†APIå·²åºŸå¼ƒ
2. ä½¿ç”¨`CrawlerServiceV2`çš„ä»£ç APIæ›¿ä»£
3. æ— éœ€æ‰‹åŠ¨ç®¡ç†çª—å£æ± å’Œä»»åŠ¡é˜Ÿåˆ—
4. çˆ¬è™«ä¼šè‡ªåŠ¨å¯åŠ¨ï¼Œæ— éœ€åˆå§‹åŒ–

## ğŸ“ å¼€å‘æ³¨æ„äº‹é¡¹

### ğŸ—ï¸ æ¶æ„åŸåˆ™

1. **åˆ†å±‚èŒè´£ä¸¥æ ¼åˆ†ç¦»**ï¼š
   - âŒ ä¸šåŠ¡å±‚ä¸èƒ½ç›´æ¥è°ƒç”¨çˆ¬è™«æ–¹æ³•
   - âŒ çˆ¬è™«æ–¹æ³•ä¸èƒ½ç›´æ¥ç®¡ç†çª—å£æ± 
   - âœ… å¿…é¡»é€šè¿‡ session_manager è·å–çª—å£

2. **ä»»åŠ¡æµç¨‹ä¸¥æ ¼éµå¾ª**ï¼š
   ```
   ä¸šåŠ¡å±‚ â†’ æ•°æ®åº“(pending) â†’ è°ƒåº¦è§¦å‘ â†’ å†…å­˜é˜Ÿåˆ— â†’ session_manager â†’ çˆ¬è™«æ‰§è¡Œ
   ```

3. **çª—å£ç®¡ç†ç»Ÿä¸€åŸåˆ™**ï¼š
   - æ‰€æœ‰çª—å£éƒ½ç”± `autonomous_session_manager` ç®¡ç†
   - çˆ¬è™«æ–¹æ³•é€šè¿‡ `acquire_window()` è·å–ï¼Œ`release_window()` å½’è¿˜
   - å°æ§çŠ¶æ€ã€è´Ÿè½½å‡è¡¡éƒ½ç”± session_manager å¤„ç†

### ğŸ”§ æŠ€æœ¯é…ç½®

1. **Chromeé…ç½®**ï¼šç¡®ä¿Chromeä»¥è°ƒè¯•æ¨¡å¼è¿è¡Œï¼ˆç«¯å£9222ï¼‰
2. **æ•°æ®å®‰å…¨**ï¼šå®šæœŸå¤‡ä»½`data/sellbook.db`æ•°æ®åº“
3. **ä»»åŠ¡ç›‘æ§**ï¼šå¯é€šè¿‡`health_check()`å’Œ`get_queue_status()`ç›‘æ§ç³»ç»ŸçŠ¶æ€
4. **é”™è¯¯æ¢å¤**ï¼šç³»ç»Ÿå…·æœ‰è‡ªåŠ¨é‡è¯•å’ŒçŠ¶æ€æ¢å¤æœºåˆ¶
5. **èµ„æºç®¡ç†**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨ç®¡ç†æµè§ˆå™¨èµ„æºï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†

### ğŸš¨ å¸¸è§åæ¨¡å¼

```python
# âŒ é”™è¯¯ï¼šä¸šåŠ¡å±‚ç›´æ¥è°ƒç”¨çˆ¬è™«
async def api_crawl_book(isbn: str):
    # è¿åäº†åˆ†å±‚æ¶æ„ï¼Œä¸šåŠ¡å±‚ä¸åº”è¯¥ç›´æ¥æ‰§è¡Œçˆ¬å–
    return await crawler.crawl_single_book_sales(isbn, shop_id)

# âœ… æ­£ç¡®ï¼šä¸šåŠ¡å±‚åªåˆ›å»ºä»»åŠ¡
def api_crawl_book(isbn: str):
    # åªåˆ›å»ºä»»åŠ¡ï¼Œä¸æ‰§è¡Œï¼Œç”±è°ƒåº¦å±‚æ‰‹åŠ¨è§¦å‘
    task = CrawlTask(task_type='book_sales_crawl', target_isbn=isbn, status='pending')
    return task_repo.create(task)

# âŒ é”™è¯¯ï¼šæ‰‹åŠ¨ç®¡ç†çª—å£ç”Ÿå‘½å‘¨æœŸ
async def crawl_method(isbn: str, session_manager=None):
    # è¿åäº†è£…é¥°å™¨æ¨¡å¼ï¼Œæ‰‹åŠ¨ç®¡ç†çª—å£å¤æ‚ä¸”æ˜“å‡ºé”™
    window_session = await session_manager.acquire_window('kongfz')
    try:
        page = window_session.page
        # æ‰§è¡Œçˆ¬å–é€»è¾‘
    finally:
        await session_manager.release_window(window_session)

# âœ… æ­£ç¡®ï¼šä½¿ç”¨ WindowPoolManager è£…é¥°å™¨
@WindowPoolManager()
async def crawl_method(isbn: str, page: Page = None):
    # è£…é¥°å™¨è‡ªåŠ¨å¤„ç†çª—å£è·å–ã€å¼‚å¸¸å¤„ç†ã€å½’è¿˜
    # çˆ¬è™«æ–¹æ³•åªéœ€ä¸“æ³¨ä¸šåŠ¡é€»è¾‘
    await page.goto(f"https://www.kongfz.com/book/{isbn}")
    # æ‰§è¡Œå…·ä½“çˆ¬å–é€»è¾‘
```

## ğŸ‰ æ›´æ–°æ—¥å¿—

### v3.0 (2025-01) ğŸš€
- âœ¨ **å…¨æ–°å››å±‚åˆ†ç¦»æ¶æ„**ï¼šä¸šåŠ¡å±‚ â†’ è°ƒåº¦å±‚ â†’ æ‰§è¡Œå±‚ â†’ çˆ¬è™«å±‚å®Œå…¨è§£è€¦
- ğŸ¯ **æ ¸å¿ƒæ¶æ„ç†å¿µ**ï¼š
  - ä¸šåŠ¡å±‚åªè´Ÿè´£ä»»åŠ¡åˆ›å»ºåˆ°æ•°æ®åº“
  - è°ƒåº¦å±‚æ‰‹åŠ¨è§¦å‘ä»»åŠ¡åŠ è½½åˆ°å†…å­˜é˜Ÿåˆ—  
  - æ‰§è¡Œå±‚(AutonomousSessionManager)ä½œä¸ºç»Ÿä¸€çª—å£åˆ†å‘ä¸­å¿ƒ
  - çˆ¬è™«å±‚ä» session_manager è·å–çª—å£æ‰§è¡Œå…·ä½“çˆ¬å–
- ğŸ¤– **AutonomousSessionManager**ï¼šç»Ÿä¸€çª—å£æ± ç®¡ç†ï¼Œå°æ§çŠ¶æ€è¿½è¸ªï¼Œæ™ºèƒ½ä»»åŠ¡åˆ†å‘
- ğŸ“‹ **æ‰‹åŠ¨è°ƒåº¦æ§åˆ¶**ï¼šé€šè¿‡çˆ¬è™«ç®¡ç†é¡µé¢æŒ‰é’®å®Œå…¨æ§åˆ¶ä»»åŠ¡æ‰§è¡Œæ—¶æœº
- ğŸ”„ **ç»Ÿä¸€çª—å£ç®¡ç†**ï¼šæ‰€æœ‰çˆ¬è™«æ–¹æ³•é€šè¿‡ `acquire_window()` è·å–çª—å£ï¼Œ`release_window()` å½’è¿˜
- ğŸ›¡ï¸ **åˆ†å±‚èŒè´£ä¸¥æ ¼**ï¼šç¦æ­¢è·¨å±‚ç›´æ¥è°ƒç”¨ï¼Œç¡®ä¿æ¶æ„æ¸…æ™°
- âš¡ **é›¶è€¦åˆè®¾è®¡**ï¼šä¸šåŠ¡å±‚ä¸çˆ¬è™«æ‰§è¡Œå®Œå…¨æ— æ„ŸçŸ¥
- ğŸ“Š **å®Œæ•´ç›‘æ§ä½“ç³»**ï¼šåˆ†å±‚çŠ¶æ€æŸ¥è¯¢ï¼Œå†…å­˜é˜Ÿåˆ—ä¸æ•°æ®åº“ä»»åŠ¡ç»Ÿè®¡åˆ†ç¦»

### v2.x (2024-01)
- åº—é“ºå’Œä¹¦ç±ç®¡ç†æ¨¡å—
- ISBNå®æ—¶æœç´¢åˆ†æ
- å¢é‡çˆ¬å–åŠŸèƒ½

### v1.0 (2023-12)
- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ