<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Price Analysis - 数据分析</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
/* 极简扁平风格主题 */
:root {
  --background: #ffffff;
  --foreground: #171717;
  --card: #ffffff;
  --card-foreground: #171717;
  --primary: #667eea;
  --primary-foreground: #ffffff;
  --primary-hover: #5a67d8;
  --secondary: #f3f4f6;
  --secondary-foreground: #171717;
  --muted: #f9fafb;
  --muted-foreground: #6b7280;
  --border: #e5e7eb;
  --success: #10b981;
  --destructive: #ef4444;
  --warning: #f59e0b;
  --sidebar-bg: #fafafa;
  --sidebar-foreground: #171717;
  --sidebar-border: #e5e7eb;
  --sidebar-hover-bg: #f3f4f6;
  --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
  --radius: 8px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  --sidebar-width: 240px;
  --header-height: 64px;
  --nav-item-height: 48px;
  --transition-fast: 150ms ease;
  --text-sm: 14px;
  --text-base: 16px;
  --text-lg: 18px;
  --text-xl: 20px;
  --text-2xl: 24px;
  --font-medium: 500;
  --font-semibold: 600;
}

[data-theme="dark"] {
  --background: #0a0a0a;
  --foreground: #fafafa;
  --card: #171717;
  --card-foreground: #fafafa;
  --secondary: #262626;
  --muted: #262626;
  --muted-foreground: #a3a3a3;
  --border: #262626;
  --sidebar-bg: #0f0f0f;
  --sidebar-foreground: #fafafa;
  --sidebar-border: #262626;
  --sidebar-hover-bg: #262626;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: var(--font-sans);
  font-size: var(--text-base);
  line-height: 1.5;
  color: var(--foreground);
  background: var(--background);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* 新的布局系统 */
.app-container {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

.sidebar {
  width: var(--sidebar-width);
  background: var(--sidebar-bg);
  border-right: 1px solid var(--sidebar-border);
  display: flex;
  flex-direction: column;
  transition: transform var(--transition-fast);
}

.sidebar-logo {
  height: var(--header-height);
  padding: 0 var(--spacing-lg);
  display: flex;
  align-items: center;
  border-bottom: 1px solid var(--sidebar-border);
  font-size: var(--text-lg);
  font-weight: var(--font-semibold);
  color: var(--primary);
}

.sidebar-nav {
  flex: 1;
  padding: var(--spacing-md) 0;
  overflow-y: auto;
}

.sidebar-nav-item {
  height: var(--nav-item-height);
  padding: 0 var(--spacing-lg);
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  color: var(--sidebar-foreground);
  text-decoration: none;
  transition: all var(--transition-fast);
  cursor: pointer;
  border-left: 3px solid transparent;
}

.sidebar-nav-item:hover {
  background: var(--sidebar-hover-bg);
}

.sidebar-nav-item.active {
  background: var(--primary);
  color: var(--primary-foreground);
  border-left-color: var(--primary-hover);
}

.sidebar-nav-divider {
  height: 1px;
  background: var(--sidebar-border);
  margin: var(--spacing-md) 0;
}

.sidebar-footer {
  padding: var(--spacing-md) 0;
  border-top: 1px solid var(--sidebar-border);
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.content-header {
  height: var(--header-height);
  padding: 0 var(--spacing-lg);
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--border);
  background: var(--card);
}

.content-title {
  font-size: var(--text-2xl);
  font-weight: var(--font-semibold);
  color: var(--foreground);
}

.content-body {
  flex: 1;
  padding: var(--spacing-lg);
  overflow-y: auto;
  background: var(--muted);
}

/* ISBN搜索模块样式 */
.isbn-search-section {
  background: var(--card);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  margin-bottom: var(--spacing-lg);
  border: 1px solid var(--border);
}

.isbn-search-header {
  text-align: center;
  margin-bottom: var(--spacing-md);
  color: var(--muted-foreground);
}

.isbn-search-header h3 {
  font-size: var(--text-lg);
  margin-bottom: var(--spacing-sm);
  color: var(--foreground);
}

.isbn-search-box {
  display: flex;
  gap: var(--spacing-sm);
  max-width: 600px;
  margin: 0 auto var(--spacing-md);
}

.isbn-search-input {
  flex: 1;
  padding: var(--spacing-md);
  font-size: var(--text-base);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  outline: none;
  transition: all var(--transition-fast);
  background: var(--card);
  color: var(--foreground);
}

.isbn-search-input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn {
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--radius);
  font-size: var(--text-sm);
  font-weight: var(--font-medium);
  border: none;
  cursor: pointer;
  transition: all var(--transition-fast);
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-sm);
}

.btn-primary {
  background: var(--primary);
  color: var(--primary-foreground);
}

.btn-primary:hover {
  background: var(--primary-hover);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-ghost {
  background: transparent;
  color: var(--foreground);
}

.btn-ghost:hover {
  background: var(--secondary);
}

.isbn-loading {
  text-align: center;
  padding: var(--spacing-lg);
  color: var(--muted-foreground);
  display: none;
}

.isbn-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--border);
  border-top: 2px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: var(--spacing-sm);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.isbn-results {
  display: none;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.stat-card {
  background: var(--card);
  padding: var(--spacing-lg);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  transition: all var(--transition-fast);
}

.stat-card:hover {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.stat-label {
  font-size: var(--text-sm);
  color: var(--muted-foreground);
  margin-bottom: var(--spacing-sm);
}

.stat-value {
  font-size: var(--text-2xl);
  font-weight: 700;
  color: var(--primary);
}

.isbn-price-stats {
  background: var(--secondary);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-md);
}

.isbn-price-stats h3 {
  margin-bottom: var(--spacing-sm);
  color: var(--foreground);
  font-size: var(--text-lg);
}

.isbn-price-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: var(--spacing-sm);
}

.isbn-price-item {
  text-align: center;
  padding: var(--spacing-sm);
  background: var(--card);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.isbn-price-label {
  font-size: var(--text-sm);
  color: var(--muted-foreground);
  margin-bottom: var(--spacing-sm);
}

.isbn-price-value {
  font-size: var(--text-lg);
  font-weight: var(--font-semibold);
  color: var(--success);
}

.isbn-chart-container {
  background: var(--card);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  border: 1px solid var(--border);
}

.isbn-chart-container h3 {
  margin-bottom: var(--spacing-sm);
  color: var(--foreground);
  font-size: var(--text-lg);
}

#isbnSalesChart {
  max-height: 300px;
}

.isbn-error {
  background: #fee;
  color: var(--destructive);
  padding: var(--spacing-md);
  border-radius: var(--radius);
  margin: var(--spacing-md) 0;
  display: none;
  border: 1px solid #fecaca;
}

.isbn-info {
  background: #dbeafe;
  color: #1976d2;
  padding: var(--spacing-md);
  border-radius: var(--radius);
  margin-bottom: var(--spacing-md);
  font-weight: var(--font-medium);
  border: 1px solid #bfdbfe;
}

/* 标题部分样式 */
.section-header {
  background: var(--card);
  border-radius: var(--radius);
  padding: var(--spacing-md) var(--spacing-lg);
  margin: var(--spacing-lg) auto;
  max-width: 400px;
  text-align: center;
  border: 1px solid var(--border);
}

.section-header h2 {
  color: var(--foreground);
  font-size: var(--text-xl);
  font-weight: var(--font-semibold);
  margin: 0;
}

/* 时间筛选器 */
.time-filters {
  display: flex;
  justify-content: center;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-lg);
}

.time-filter {
  padding: var(--spacing-sm) var(--spacing-md);
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  font-size: var(--text-sm);
  transition: all var(--transition-fast);
  color: var(--foreground);
}

.time-filter:hover {
  background: var(--secondary);
}

.time-filter.active {
  background: var(--primary);
  color: var(--primary-foreground);
  border-color: var(--primary);
}

.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
}

.card {
  background: var(--card);
  border-radius: var(--radius);
  padding: var(--spacing-lg);
  border: 1px solid var(--border);
  transition: all var(--transition-fast);
}

.card:hover {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.card h2 {
  color: var(--foreground);
  margin-bottom: var(--spacing-md);
  font-size: var(--text-lg);
  border-bottom: 2px solid var(--primary);
  padding-bottom: var(--spacing-sm);
}

.dashboard .stat-value {
  font-size: 2em;
  font-weight: 700;
  color: var(--primary);
  margin: var(--spacing-sm) 0;
}

.dashboard .stat-label {
  color: var(--muted-foreground);
  font-size: var(--text-sm);
}

.stat-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-md);
  margin-top: var(--spacing-md);
}

.stat-item {
  text-align: center;
  padding: var(--spacing-sm);
  background: var(--secondary);
  border-radius: var(--radius);
}

/* 数据表格 */
.data-table {
  background: var(--card);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  overflow: hidden;
  margin-bottom: var(--spacing-lg);
}

.data-table table {
  width: 100%;
  border-collapse: collapse;
}

.data-table th {
  background: var(--muted);
  padding: var(--spacing-md);
  text-align: left;
  font-weight: var(--font-medium);
  font-size: var(--text-sm);
  color: var(--muted-foreground);
  border-bottom: 1px solid var(--border);
}

.data-table td {
  padding: var(--spacing-md);
  border-bottom: 1px solid var(--border);
  color: var(--foreground);
}

.data-table tr:hover {
  background: var(--muted);
}

.price {
  color: var(--success);
  font-weight: var(--font-semibold);
}

.profit {
  color: var(--destructive);
  font-weight: var(--font-semibold);
}

.rank {
  display: inline-block;
  width: 24px;
  height: 24px;
  line-height: 24px;
  text-align: center;
  border-radius: 50%;
  background: var(--primary);
  color: var(--primary-foreground);
  font-weight: var(--font-semibold);
  font-size: var(--text-sm);
}

.search-box {
  background: var(--card);
  border-radius: var(--radius);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-lg);
  display: flex;
  gap: var(--spacing-sm);
  border: 1px solid var(--border);
  max-width: 500px;
  margin-left: auto;
  margin-right: auto;
}

.search-box input {
  flex: 1;
  border: none;
  outline: none;
  font-size: var(--text-base);
  background: transparent;
  color: var(--foreground);
}

.search-box input::placeholder {
  color: var(--muted-foreground);
}

.loading {
  text-align: center;
  padding: var(--spacing-lg);
  color: var(--muted-foreground);
}

.chart-container {
  height: 300px;
  margin-top: var(--spacing-md);
}

.tab-nav {
  display: flex;
  gap: var(--spacing-sm);
  border-bottom: 1px solid var(--border);
  margin-bottom: var(--spacing-lg);
}

.tab-btn {
  padding: var(--spacing-sm) var(--spacing-md);
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--muted-foreground);
  cursor: pointer;
  transition: all var(--transition-fast);
  font-size: var(--text-sm);
}

.tab-btn:hover {
  color: var(--foreground);
}

.tab-btn.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* 移动端样式 */
.mobile-menu-btn {
  display: none;
  position: fixed;
  top: var(--spacing-md);
  left: var(--spacing-md);
  z-index: 101;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: var(--spacing-sm);
  cursor: pointer;
}

.theme-toggle {
  padding: var(--spacing-sm);
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  display: flex;
  align-items: center;
  transition: all var(--transition-fast);
}

.theme-toggle:hover {
  background: var(--secondary);
}

/* 响应式 */
@media (max-width: 768px) {
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    z-index: 100;
    transform: translateX(-100%);
  }
  
  .sidebar.open {
    transform: translateX(0);
  }
  
  .main-content {
    margin-left: 0;
  }
  
  .mobile-menu-btn {
    display: flex;
  }
  
  .content-header {
    padding-left: calc(48px + var(--spacing-lg));
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .time-filters {
    flex-wrap: wrap;
  }
  
  .tab-nav {
    flex-wrap: wrap;
  }
}
    </style>
</head>
<body>
    <!-- 移动端菜单按钮 -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">
        <i data-lucide="menu" width="20" height="20"></i>
    </button>

    <!-- 主容器 -->
    <div class="app-container">
        <!-- 侧边栏 -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                📊 Book Price Analysis
            </div>
            
            <nav class="sidebar-nav">
                <a href="/" class="sidebar-nav-item active">
                    <i data-lucide="home" width="18" height="18"></i>
                    仪表板
                </a>
                <a href="/shop-admin" class="sidebar-nav-item">
                    <i data-lucide="store" width="18" height="18"></i>
                    店铺管理
                </a>
                <a href="/book-admin" class="sidebar-nav-item">
                    <i data-lucide="book" width="18" height="18"></i>
                    书籍管理
                </a>
                <a href="/sales-admin" class="sidebar-nav-item">
                    <i data-lucide="trending-up" width="18" height="18"></i>
                    销售管理
                </a>
                <a href="/crawler-admin" class="sidebar-nav-item">
                    <i data-lucide="spider" width="18" height="18"></i>
                    爬虫管理
                </a>
                
                <div class="sidebar-nav-divider"></div>
            </nav>
            
            <div class="sidebar-footer">
                <a href="#" class="sidebar-nav-item" onclick="showSettings()">
                    <i data-lucide="settings" width="18" height="18"></i>
                    设置
                </a>
            </div>
        </aside>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 内容头部 -->
            <header class="content-header">
                <h1 class="content-title">数据分析仪表板</h1>
                <div style="display: flex; gap: var(--spacing-sm); align-items: center;">
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i data-lucide="sun" width="20" height="20"></i>
                    </button>
                    <button class="btn btn-ghost">
                        <i data-lucide="refresh-cw" width="16" height="16"></i>
                        刷新
                    </button>
                </div>
            </header>

            <!-- 内容主体 -->
            <div class="content-body">

                <!-- ISBN搜索分析模块 -->
                <div class="isbn-search-section">
                    <div class="isbn-search-header">
                        <h3>ISBN实时搜索分析</h3>
                        <p style="color: var(--muted-foreground); margin-top: var(--spacing-sm);">输入ISBN号码，实时分析书籍销售数据</p>
                    </div>

                    <div class="isbn-search-box">
                        <input type="text" class="isbn-search-input" id="isbnInput" placeholder="请输入书籍ISBN号码，例如：9787521724493">
                        <button class="btn btn-primary" id="isbnSearchBtn" onclick="searchBookISBN()">
                            <i data-lucide="search" width="16" height="16"></i>
                            分析
                        </button>
                    </div>

                    <div class="isbn-loading" id="isbnLoading">
                        <div class="isbn-spinner"></div>
                        正在分析数据，请稍候...
                    </div>

                    <div class="isbn-error" id="isbnError"></div>

                    <div class="isbn-results" id="isbnResults">
                        <div class="isbn-info" id="isbnInfo"></div>

                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">
                                    <i data-lucide="calendar" width="16" height="16" style="display: inline; vertical-align: middle;"></i>
                                    1天内销量
                                </div>
                                <div class="stat-value" id="isbnSales1Day">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">
                                    <i data-lucide="calendar" width="16" height="16" style="display: inline; vertical-align: middle;"></i>
                                    7天内销量
                                </div>
                                <div class="stat-value" id="isbnSales7Days">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">
                                    <i data-lucide="calendar" width="16" height="16" style="display: inline; vertical-align: middle;"></i>
                                    30天内销量
                                </div>
                                <div class="stat-value" id="isbnSales30Days">-</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">
                                    <i data-lucide="bar-chart" width="16" height="16" style="display: inline; vertical-align: middle;"></i>
                                    总记录数
                                </div>
                                <div class="stat-value" id="isbnTotalRecords">-</div>
                            </div>
                        </div>

                        <div class="isbn-price-stats">
                            <h3>💰 价格统计</h3>
                    <div class="isbn-price-grid">
                        <div class="isbn-price-item">
                            <div class="isbn-price-label">平均价格</div>
                            <div class="isbn-price-value" id="isbnAvgPrice">-</div>
                        </div>
                        <div class="isbn-price-item">
                            <div class="isbn-price-label">最低价格</div>
                            <div class="isbn-price-value" id="isbnMinPrice">-</div>
                        </div>
                        <div class="isbn-price-item">
                            <div class="isbn-price-label">最高价格</div>
                            <div class="isbn-price-value" id="isbnMaxPrice">-</div>
                        </div>
                        <div class="isbn-price-item">
                            <div class="isbn-price-label">最新销售</div>
                            <div class="isbn-price-value" id="isbnLatestSale">-</div>
                        </div>
                    </div>
                </div>

                            <div class="isbn-chart-container">
                                <h3>📈 销售趋势</h3>
                                <canvas id="isbnSalesChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 时间筛选器 -->
                <div class="time-filters">
                    <button class="time-filter active" onclick="filterByDays(3)">3天</button>
                    <button class="time-filter" onclick="filterByDays(7)">7天</button>
                    <button class="time-filter" onclick="filterByDays(30)">30天</button>
                    <button class="time-filter" onclick="filterByDays(0)">全部</button>
                </div>

                <!-- 多标签页内容区 -->
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="switchTab(this, 'salesRank')">📊 销量排行</button>
                    <button class="tab-btn" onclick="switchTab(this, 'priceDiffRank')">💰 差价排行</button>
                    <button class="tab-btn" onclick="switchTab(this, 'profitRank')">🎯 预期利润</button>
                </div>

                <!-- 数据表格 -->
                <div class="data-table">
                    <div id="salesRank" class="tab-content active">
                        <table id="salesRankTable">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>书名</th>
                                    <th>ISBN</th>
                                    <th>销量</th>
                                    <th>平均价格</th>
                                    <th>总成本</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="7" style="text-align: center;">加载中...</td></tr>
                            </tbody>
                        </table>
                        <div style="display: flex; justify-content: center; align-items: center; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                            <button class="btn btn-ghost" onclick="loadSalesRank(currentSalesPage - 1)" id="salesPrevBtn">
                                <i data-lucide="chevron-left" width="16" height="16"></i>
                            </button>
                            <span id="salesPageInfo" style="color: var(--muted-foreground);">第 1 页</span>
                            <button class="btn btn-ghost" onclick="loadSalesRank(currentSalesPage + 1)" id="salesNextBtn">
                                <i data-lucide="chevron-right" width="16" height="16"></i>
                            </button>
                        </div>
                    </div>

                    <div id="priceDiffRank" class="tab-content">
                        <table id="priceDiffTable">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>书名</th>
                                    <th>ISBN</th>
                                    <th>孔夫子价格</th>
                                    <th>多抓鱼价格</th>
                                    <th>差价</th>
                                    <th>利润率</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="7" style="text-align: center;">加载中...</td></tr>
                            </tbody>
                        </table>
                        <div style="display: flex; justify-content: center; align-items: center; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                            <button class="btn btn-ghost" onclick="loadPriceDiffRank(currentDiffPage - 1)" id="diffPrevBtn">
                                <i data-lucide="chevron-left" width="16" height="16"></i>
                            </button>
                            <span id="diffPageInfo" style="color: var(--muted-foreground);">第 1 页</span>
                            <button class="btn btn-ghost" onclick="loadPriceDiffRank(currentDiffPage + 1)" id="diffNextBtn">
                                <i data-lucide="chevron-right" width="16" height="16"></i>
                            </button>
                        </div>
                    </div>

                    <div id="profitRank" class="tab-content">
                        <table id="profitRankTable">
                            <thead>
                                <tr>
                                    <th>排名</th>
                                    <th>书名</th>
                                    <th>ISBN</th>
                                    <th>销量</th>
                                    <th>差价</th>
                                    <th>预期利润</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" style="text-align: center;">加载中...</td></tr>
                            </tbody>
                        </table>
                        <div style="display: flex; justify-content: center; align-items: center; gap: var(--spacing-sm); margin-top: var(--spacing-lg);">
                            <button class="btn btn-ghost" onclick="loadProfitRank(currentProfitPage - 1)" id="profitPrevBtn">
                                <i data-lucide="chevron-left" width="16" height="16"></i>
                            </button>
                            <span id="profitPageInfo" style="color: var(--muted-foreground);">第 1 页</span>
                            <button class="btn btn-ghost" onclick="loadProfitRank(currentProfitPage + 1)" id="profitNextBtn">
                                <i data-lucide="chevron-right" width="16" height="16"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 本地库书籍查询 -->
                <div class="section-header">
                    <h2>本地库书籍查询</h2>
                </div>

                <!-- 搜索框 -->
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="搜索书籍名称...">
                    <button class="btn btn-primary" onclick="searchBooks()">
                        <i data-lucide="search" width="16" height="16"></i>
                        搜索
                    </button>
                </div>

                <!-- 仪表板统计卡片 -->
                <div class="stats-grid" id="dashboard">
            <div class="card">
                <h2>📊 销量统计</h2>
                <div class="stat-value" id="totalSales">加载中...</div>
                <div class="stat-label">总销售记录</div>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div>今日</div>
                        <div style="font-weight: bold;" id="todaySales">-</div>
                    </div>
                    <div class="stat-item">
                        <div>本周</div>
                        <div style="font-weight: bold;" id="weekSales">-</div>
                    </div>
                    <div class="stat-item">
                        <div>本月</div>
                        <div style="font-weight: bold;" id="monthSales">-</div>
                    </div>
                    <div class="stat-item">
                        <div>增长率</div>
                        <div style="font-weight: bold; color: #28a745;" id="growthRate">-</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>💰 价格分析</h2>
                <div class="stat-value" id="avgPrice">¥0</div>
                <div class="stat-label">平均售价</div>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div>最高价</div>
                        <div style="font-weight: bold;" id="maxPrice">-</div>
                    </div>
                    <div class="stat-item">
                        <div>最低价</div>
                        <div style="font-weight: bold;" id="minPrice">-</div>
                    </div>
                    <div class="stat-item">
                        <div>中位数</div>
                        <div style="font-weight: bold;" id="medianPrice">-</div>
                    </div>
                    <div class="stat-item">
                        <div>价格区间</div>
                        <div style="font-weight: bold;" id="priceRange">-</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>🎯 商机分析</h2>
                <div class="stat-value" id="totalInventory">0</div>
                <div class="stat-label">监控书籍数</div>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div>盈利机会</div>
                        <div style="font-weight: bold; color: #28a745;" id="activeItems">-</div>
                    </div>
                    <div class="stat-item">
                        <div>发现率</div>
                        <div style="font-weight: bold; color: #dc3545;" id="outOfStock">-</div>
                    </div>
                    <div class="stat-item">
                        <div>监控店铺</div>
                        <div style="font-weight: bold; color: #007bff;" id="newItems">-</div>
                    </div>
                    <div class="stat-item">
                        <div>平均收益率</div>
                        <div style="font-weight: bold;" id="turnoverRate">-</div>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // 初始化图标
        lucide.createIcons();

        let currentDays = 3;
        let charts = {};
        let isbnSalesChart = null;
        let currentSalesPage = 1;
        let currentDiffPage = 1;
        let currentProfitPage = 1;
        const pageSize = 20;

        // 侧边栏切换
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // 主题切换
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            
            // 更新图标
            const icon = document.querySelector('.theme-toggle i');
            icon.setAttribute('data-lucide', newTheme === 'dark' ? 'moon' : 'sun');
            lucide.createIcons();
        }

        // ISBN搜索功能
        function searchBookISBN() {
            const isbn = document.getElementById('isbnInput').value.trim();

            if (!isbn) {
                showISBNError('请输入ISBN号码');
                return;
            }

            if (isbn.length < 10) {
                showISBNError('请输入有效的ISBN号码');
                return;
            }

            analyzeBookISBN(isbn);
        }

        async function analyzeBookISBN(isbn) {
            // 显示加载状态
            document.getElementById('isbnLoading').style.display = 'block';
            document.getElementById('isbnResults').style.display = 'none';
            document.getElementById('isbnError').style.display = 'none';
            document.getElementById('isbnSearchBtn').disabled = true;

            try {
                const response = await fetch(`/api/book/analyze?isbn=${encodeURIComponent(isbn)}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    displayISBNResults(data);
                } else {
                    showISBNError(data.message || '分析失败，请稍后重试');
                }
            } catch (error) {
                console.error('分析失败:', error);
                showISBNError('网络错误，请检查连接后重试');
            } finally {
                document.getElementById('isbnLoading').style.display = 'none';
                document.getElementById('isbnSearchBtn').disabled = false;
            }
        }

        function displayISBNResults(data) {
            // 显示结果区域
            document.getElementById('isbnResults').style.display = 'block';

            // 显示ISBN信息
            document.getElementById('isbnInfo').textContent = `ISBN: ${data.isbn}`;

            // 显示统计数据
            const stats = data.stats;
            document.getElementById('isbnSales1Day').textContent = stats.sales_1_day || 0;
            document.getElementById('isbnSales7Days').textContent = stats.sales_7_days || 0;
            document.getElementById('isbnSales30Days').textContent = stats.sales_30_days || 0;
            document.getElementById('isbnTotalRecords').textContent = stats.total_records || 0;

            // 显示价格信息
            if (stats.average_price) {
                document.getElementById('isbnAvgPrice').textContent = `¥${stats.average_price}`;
            } else {
                document.getElementById('isbnAvgPrice').textContent = '-';
            }

            if (stats.price_range && stats.price_range.min !== null) {
                document.getElementById('isbnMinPrice').textContent = `¥${stats.price_range.min}`;
                document.getElementById('isbnMaxPrice').textContent = `¥${stats.price_range.max}`;
            } else {
                document.getElementById('isbnMinPrice').textContent = '-';
                document.getElementById('isbnMaxPrice').textContent = '-';
            }

            if (stats.latest_sale_date) {
                const date = new Date(stats.latest_sale_date);
                document.getElementById('isbnLatestSale').textContent = date.toLocaleDateString('zh-CN');
            } else {
                document.getElementById('isbnLatestSale').textContent = '-';
            }

            // 绘制趋势图
            drawISBNSalesChart(stats);
        }

        function drawISBNSalesChart(stats) {
            const ctx = document.getElementById('isbnSalesChart').getContext('2d');

            // 销毁旧图表
            if (isbnSalesChart) {
                isbnSalesChart.destroy();
            }

            // 创建模拟数据
            const labels = [];
            const data = [];
            const today = new Date();

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.getMonth() + 1 + '/' + date.getDate());

                // 生成模拟数据
                if (i < 7) {
                    data.push(Math.floor(Math.random() * 5) + 1);
                } else if (i < 14) {
                    data.push(Math.floor(Math.random() * 3));
                } else {
                    data.push(Math.floor(Math.random() * 2));
                }
            }

            // 计算y轴的最大值
            const maxValue = Math.max(...data);
            const yMax = maxValue > 0 ? Math.ceil(maxValue * 1.2) : 10;

            isbnSalesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '日销量',
                        data: data,
                        backgroundColor: 'rgba(76, 175, 80, 0.6)',
                        borderColor: '#4CAF50',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 3,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: yMax,
                            ticks: {
                                stepSize: Math.ceil(yMax / 10),
                                callback: function(value) {
                                    if (Math.floor(value) === value) {
                                        return value;
                                    }
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function showISBNError(message) {
            const errorDiv = document.getElementById('isbnError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('isbnResults').style.display = 'none';
        }

        // 回车键触发搜索
        document.getElementById('isbnInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchBookISBN();
            }
        });

        // 原有功能继续保留
        function filterByDays(days) {
            currentDays = days;
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            loadDashboardData();
        }

        function switchTab(tabName) {
            // 切换标签按钮状态
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 切换内容显示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // 重置页码并加载对应数据
            switch(tabName) {
                case 'salesRank':
                    currentSalesPage = 1;
                    loadSalesRank(1);
                    break;
                case 'priceDiffRank':
                    currentDiffPage = 1;
                    loadPriceDiffRank(1);
                    break;
                case 'profitRank':
                    currentProfitPage = 1;
                    loadProfitRank(1);
                    break;
            }
        }

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard');
                const data = await response.json();

                if (data.success) {
                    updateDashboard(data.data);
                }
            } catch (error) {
                console.error('加载数据失败:', error);
            }
        }

        function updateDashboard(data) {
            // 使用新的商机分析数据结构
            const todayStats = data.today_stats || {};
            const businessStats = data.business_opportunity_stats || {};
            // 更新销量统计 - 显示商机分析数据
            document.getElementById('totalSales').textContent = businessStats.total_books_monitored || todayStats.total_sales || 0;
            document.getElementById('todaySales').textContent = todayStats.total_sales || 0;
            document.getElementById('weekSales').textContent = todayStats.total_sales || 0;
            document.getElementById('monthSales').textContent = todayStats.total_sales || 0;
            document.getElementById('growthRate').textContent = `0%`;

            // 更新价格分析 - 使用市场价格数据
            document.getElementById('avgPrice').textContent = `¥${businessStats.avg_market_price || 0}`;
            document.getElementById('maxPrice').textContent = `¥${businessStats.max_price || 0}`;
            document.getElementById('minPrice').textContent = `¥${businessStats.min_price || 0}`;
            document.getElementById('medianPrice').textContent = `¥${businessStats.avg_market_price || 0}`;
            document.getElementById('priceRange').textContent = businessStats.price_range || '¥0-0';

            // 更新商机分析
            document.getElementById('totalInventory').textContent = businessStats.total_books_monitored || 0;
            document.getElementById('activeItems').textContent = businessStats.profitable_opportunities || 0;
            document.getElementById('outOfStock').textContent = `${businessStats.profit_discovery_rate || 0}%`;
            document.getElementById('newItems').textContent = businessStats.monitored_shops || 0;
            document.getElementById('turnoverRate').textContent = `${businessStats.avg_profit_margin || 0}%`;
        }

        // 销量排行
        async function loadSalesRank(page = 1) {
            try {
                const offset = (page - 1) * pageSize;
                const days = currentDays === 0 ? 9999 : currentDays;
                const response = await fetch(`/api/sales/hot?days=${days}&limit=${pageSize}&offset=${offset}`);
                const data = await response.json();

                if (data.success) {
                    currentSalesPage = page;
                    const tbody = document.querySelector('#salesRankTable tbody');
                    tbody.innerHTML = '';

                    data.data.forEach((item, index) => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td><span class="rank">${offset + index + 1}</span></td>
                            <td>${item.title || '-'}</td>
                            <td>${item.isbn || '-'}</td>
                            <td>${item.sales_count}</td>
                            <td class="price">¥${item.avg_price || 0}</td>
                            <td class="price">¥${item.total_revenue || 0}</td>
                        `;
                    });

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无数据</td></tr>';
                    }

                    // 更新分页信息
                    document.getElementById('salesPageInfo').textContent = `第 ${page} 页`;
                    document.getElementById('salesPrevBtn').disabled = page === 1;
                    document.getElementById('salesNextBtn').disabled = data.data.length < pageSize;
                }
            } catch (error) {
                console.error('加载销量排行失败:', error);
            }
        }

        // 差价排行
        async function loadPriceDiffRank(page = 1) {
            try {
                const offset = (page - 1) * pageSize;
                const response = await fetch(`/api/profitable/items?min_margin=0&limit=${pageSize}&offset=${offset}`);
                const data = await response.json();

                if (data.success) {
                    currentDiffPage = page;
                    const tbody = document.querySelector('#priceDiffTable tbody');
                    tbody.innerHTML = '';

                    data.data.forEach((item, index) => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td><span class="rank">${offset + index + 1}</span></td>
                            <td>${item.title || '-'}</td>
                            <td>${item.isbn || '-'}</td>
                            <td class="price">¥${item.kongfuzi_price || 0}</td>
                            <td class="price">¥${item.duozhuayu_price || 0}</td>
                            <td class="profit">¥${item.price_diff || 0}</td>
                            <td class="profit">${item.profit_rate || 0}%</td>
                        `;
                    });

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">暂无数据</td></tr>';
                    }

                    // 更新分页信息
                    document.getElementById('diffPageInfo').textContent = `第 ${page} 页`;
                    document.getElementById('diffPrevBtn').disabled = page === 1;
                    document.getElementById('diffNextBtn').disabled = data.data.length < pageSize;
                }
            } catch (error) {
                console.error('加载差价排行失败:', error);
            }
        }

        // 预期利润排行（销量 × 差价）
        async function loadProfitRank(page = 1) {
            try {
                const offset = (page - 1) * pageSize;
                const days = currentDays === 0 ? 9999 : currentDays;
                // 这里需要后端支持，暂时用模拟数据
                const response = await fetch(`/api/sales/hot?days=${days}&limit=${pageSize}&offset=${offset}`);
                const data = await response.json();

                if (data.success) {
                    currentProfitPage = page;
                    const tbody = document.querySelector('#profitRankTable tbody');
                    tbody.innerHTML = '';

                    // 计算预期利润并排序
                    const profitData = data.data.map(item => ({
                        ...item,
                        price_diff: Math.random() * 50 + 10, // 模拟差价
                        expected_profit: item.sales_count * (Math.random() * 50 + 10)
                    })).sort((a, b) => b.expected_profit - a.expected_profit);

                    profitData.forEach((item, index) => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td><span class="rank">${offset + index + 1}</span></td>
                            <td>${item.title || '-'}</td>
                            <td>${item.isbn || '-'}</td>
                            <td>${item.sales_count}</td>
                            <td class="profit">¥${item.price_diff.toFixed(2)}</td>
                            <td class="profit" style="font-weight: bold;">¥${item.expected_profit.toFixed(2)}</td>
                        `;
                    });

                    if (profitData.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">暂无数据</td></tr>';
                    }

                    // 更新分页信息
                    document.getElementById('profitPageInfo').textContent = `第 ${page} 页`;
                    document.getElementById('profitPrevBtn').disabled = page === 1;
                    document.getElementById('profitNextBtn').disabled = data.data.length < pageSize;
                }
            } catch (error) {
                console.error('加载利润排行失败:', error);
            }
        }

        async function searchBooks() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            try {
                const response = await fetch(`/api/book/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.success) {
                    console.log('搜索结果:', data.data);
                    // 可以在这里添加搜索结果的显示逻辑
                }
            } catch (error) {
                console.error('搜索失败:', error);
            }
        }

        // 标签切换
        function switchTab(btn, tabName) {
            // 切换标签按钮状态
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active');
            });
            btn.classList.add('active');

            // 切换内容显示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // 重置页码并加载对应数据
            switch(tabName) {
                case 'salesRank':
                    currentSalesPage = 1;
                    loadSalesRank(1);
                    break;
                case 'priceDiffRank':
                    currentDiffPage = 1;
                    loadPriceDiffRank(1);
                    break;
                case 'profitRank':
                    currentProfitPage = 1;
                    loadProfitRank(1);
                    break;
            }
        }

        // 页面加载时初始化
        window.onload = function() {
            lucide.createIcons();
            loadDashboardData();
            loadSalesRank(1);  // 默认加载销量排行
        };
    </script>
</body>
</html>